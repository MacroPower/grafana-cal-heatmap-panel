{"version":3,"sources":["../src/cal_heatmap_ctrl.js"],"names":["TimeSeries","MetricsPanelCtrl","moment","CalHeatMapCtrl","$scope","$element","$injector","subDomains","panelDefaults","datasource","domains","Object","keys","config","animationDuration","domain","subDomain","colLimit","rowLimit","cellSize","cellPadding","cellRadius","domainGutter","label","position","rotate","width","legendStr","legendColors","min","max","empty","base","displayLegend","_","defaults","panel","angular","copy","seriesList","element","events","on","onRender","bind","onDataReceived","onDataError","onDataSnapshotLoad","onInitEditMode","seriesData","index","datapoints","alias","target","series","color","unit","length","last","utc","datapointsCount","addEditorTab","snapshotData","data","err","render","dataList","map","seriesHandler","indexOf","elem","find","_this","update","points","i","from","range","to","days","diff","cal","CalHeatMap","itemSelector","legend","split","parseFloat","x","start","toDate","domainLabelFormat","Math","init","destroy","e","console","log","innerHTML","templateUrl"],"mappings":"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","file":"cal_heatmap_ctrl.js","sourcesContent":["import TimeSeries from 'app/core/time_series2';\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport moment from 'moment';\nimport './bower_components/d3/d3.js';\nimport './bower_components/cal-heatmap/cal-heatmap.js';\n\nexport class CalHeatMapCtrl extends MetricsPanelCtrl {\n  constructor($scope, $element, $injector) {\n    super($scope, $injector);\n\n    var subDomains = {\n      'auto':  ['auto'],\n      'month': ['auto', 'week', 'x_week', 'day', 'x_day'],\n      'day':   ['auto', 'hour', 'x_hour'],\n      'hour':  ['auto', 'min', 'x_min']\n    };\n    var panelDefaults = {\n      datasource: null,\n      subDomains: subDomains,\n      domains: Object.keys(subDomains),\n      config: {\n\tanimationDuration: 0,\n        domain: 'auto',\n        subDomain: 'auto',\n        colLimit: null,\n        rowLimit: null,\n        cellSize: 10,\n        cellPadding: 2,\n        cellRadius: 0,\n        domainGutter: 2,\n        label: {\n          position: 'bottom',\n          rotate: 'null',\n          width: 60,\n        },\n        legendStr: '10,20,30,40',\n        legendColors: {\n          min: \"#666\",\n          max: \"steelblue\",\n          empty: \"#222\",\n          base: \"transparent\",\n        },\n        displayLegend: true,\n      },\n    };\n\n    _.defaults(this.panel, angular.copy(panelDefaults));\n    this.seriesList = [];\n\n    this.element = $element;\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  seriesHandler(seriesData, index) {\n    var datapoints = seriesData.datapoints;\n    var alias = seriesData.target;\n\n    var series = new TimeSeries({\n      datapoints: datapoints,\n      alias: alias,\n      color: index,\n      unit: false,\n    });\n\n    if (datapoints && datapoints.length > 0) {\n      var last = moment.utc(datapoints[datapoints.length - 1][1]);\n\n      this.datapointsCount += datapoints.length;\n    }\n\n    return series;\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options',\n                      'public/plugins/neocat-cal-heatmap-panel/editor.html',\n                      2);\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData.data);\n  }\n\n  onDataError(err) {\n    this.seriesList = [];\n    this.render([]);\n  }\n\n  onDataReceived(dataList) {\n    this.seriesList = dataList.map(this.seriesHandler.bind(this));\n    this.render(this.seriesList);\n  }\n\n  onRender() {\n    if (!this.seriesList || !this.seriesList[0])\n      return;\n\n    var subDomains = this.panel.subDomains[this.panel.config.domain];\n    if (subDomains.indexOf(this.panel.config.subDomain) < 0)\n      this.panel.config.subDomain = 'auto';\n\n    var elem = this.element.find(\".cal-heatmap-panel\")[0];\n    var _this = this;\n    var update = function() {\n      var data = {};\n      var points = _this.seriesList[0].datapoints;\n      for (var i = 0; i < points.length; i++) {\n        data[points[i][1] / 1000] = points[i][0];\n      }\n\n      var from = moment.utc(_this.range.from);\n      var to = moment.utc(_this.range.to);\n      var days = to.diff(from, \"days\") + 1;\n      var cal = _this.cal = new CalHeatMap();\n\n      var config = angular.copy(_this.panel.config)\n      config.itemSelector = elem;\n      config.data = data;\n      config.legend = config.legendStr ?\n        config.legendStr.split(/\\s*,\\s*/).map(x => parseFloat(x)) : null\n\n      if (config.domain == 'auto') {\n        config.domain = days > 31 ? \"month\" : days > 3 ? \"day\" : \"hour\";\n      }\n      if (config.subDomain == 'auto') {\n        delete config.subDomain;\n      }\n      config.start = moment.utc(_this.range.from).toDate();\n      if (config.domain == 'month') {\n        config.range = to.diff(from, \"months\") + 1;\n        config.domainLabelFormat = '%y/%m';\n      }\n      else if (config.domain == 'day') {\n        config.range = days;\n        config.domainLabelFormat = '%m/%d';\n      }\n      else if (config.domain == 'hour') {\n        config.range = to.diff(from, \"hours\") + 1;;\n        config.domainLabelFormat = '%d %H:%M';\n      }\n      config.range = Math.min(config.range, 60); // avoid browser hang\n\n      _this.cal.init(config);\n    };\n\n    if (this.cal) {\n      try {\n        this.cal.destroy(update);\n      } catch (e) {\n        console.log(\"Destroy failed: \" + e);\n        elem.innerHTML = '';\n        update();\n      }\n    } else {\n      update();\n    }\n  }\n\n}\n\nCalHeatMapCtrl.templateUrl = 'module.html';\n"]}